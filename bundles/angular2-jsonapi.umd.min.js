!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("date-fns"),require("lodash"),require("lodash-es/find"),require("lodash-es/includes"),require("@angular/core"),require("@angular/common/http"),require("rxjs/operators"),require("rxjs"),require("qs"),require("reflect-metadata")):"function"==typeof define&&define.amd?define("angular2-jsonapi",["exports","date-fns","lodash","lodash-es/find","lodash-es/includes","@angular/core","@angular/common/http","rxjs/operators","rxjs","qs","reflect-metadata"],e):e((t=t||self)["angular2-jsonapi"]={},t.dateFns,t.lodash,t.find,t.includes,t.ng.core,t.ng.common.http,t.rxjs.operators,t.rxjs,t.qs)}(this,function(t,e,r,i,n,a,o,s,l,u){"use strict";i=i&&i.hasOwnProperty("default")?i.default:i,n=n&&n.hasOwnProperty("default")?n.default:n;var d=function(){return(d=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t}).apply(this,arguments)};function p(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}var f=function(){function t(t){this.nestedDataSerialization=!1,t&&Object.assign(this,t)}return Object.defineProperty(t.prototype,"modelConfig",{get:function(){return Reflect.getMetadata("JsonApiModelConfig",this.constructor)},enumerable:!0,configurable:!0}),t.prototype.fill=function(t){Object.assign(this,t)},t.prototype.serialize=function(){return this.transformSerializedNamesToPropertyNames()},t.prototype.transformSerializedNamesToPropertyNames=function(){var t=this,e=this.getModelPropertyNames(),r={};return Object.keys(e).forEach(function(i){t&&"nestedDataSerialization"!==i&&(r[e[i]]=t[i])}),r},t.prototype.getModelPropertyNames=function(){return Reflect.getMetadata("AttributeMapping",this)||[]},t}();var c={nullValue:!1,hasMany:!1},h=function(){function t(t,e){void 0===e&&(e={}),this.modelType=t,this.options=d({},c,e)}return t.prototype.mask=function(t){var e,r;if(!t&&!this.options.nullValue)return this.options.hasMany?[]:new this.modelType;var i=null;if(this.options.hasMany){if(!Array.isArray(t))throw new Error("ERROR: JsonModelConverter: Expected array but got "+typeof t+".");i=[];try{for(var n=p(t),a=n.next();!a.done;a=n.next()){var o=a.value;if(null!==o){var s=void 0;"object"==typeof o?(s=new this.modelType).fill(o):s=o,i.push(s)}}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}}else t instanceof this.modelType?i=t:(i=new this.modelType).fill(t);return i},t.prototype.unmask=function(t){var e,r;if(!t)return t;var i=null;if(Array.isArray(t)){i=[];try{for(var n=p(t),a=n.next();!a.done;a=n.next()){var o=a.value;o&&(o instanceof f?(o.nestedDataSerialization=!0,i.push(o.serialize()),o.nestedDataSerialization=!1):i.push(o))}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}}else t instanceof f?(t.nestedDataSerialization=!0,i=t.serialize(),t.nestedDataSerialization=!1):i=t;return i},t}();var y=Symbol("AttributeMetadata"),g=function(){function t(){}return t.prototype.mask=function(t){return"string"==typeof t?e.parseISO(t):t},t.prototype.unmask=function(t){return t?t.toISOString():t},t}();var v=function(t){this.links=t.links||[],this.meta=t.meta};var b=y,m=function(t){var e={};return r.forEach(t||{},function(t,r){var i=t.links;i&&(e[r]={links:i})}),e},M=function(){function t(t,e){this.internalDatastore=t,this.modelInitialization=!1,this.relationshipLinks={},this.unresolvedRelations={},e&&(this.modelInitialization=!0,this.id=e.id,this.relationshipLinks=m(e.relationships),Object.assign(this,e.attributes),this.modelInitialization=!1)}return t.prototype.isModelInitialization=function(){return this.modelInitialization},t.prototype.syncRelationships=function(t,e,r){if(this.lastSyncModels!==e){if(t){var i=r;void 0===i&&(i=[].concat(e)),this.parseHasMany(t,e,i),this.parseBelongsTo(t,e,i)}this.lastSyncModels=e}},t.prototype.save=function(t,e,r){this.checkChanges();var i=this[b];return this.internalDatastore.saveRecord(i,this,t,e,r)},Object.defineProperty(t.prototype,"hasDirtyAttributes",{get:function(){this.checkChanges();var t=this[b],e=!1;for(var r in t){if(t.hasOwnProperty(r))if(t[r].hasDirtyAttributes){e=!0;break}}return e},enumerable:!0,configurable:!0}),t.prototype.checkChanges=function(){var t=this[y];for(var e in t){if(t.hasOwnProperty(e))t[e].nested&&(this[y][e].hasDirtyAttributes=!r.isEqual(t[e].oldValue,t[e].newValue),this[y][e].serialisationValue=t[e].converter(Reflect.getMetadata("design:type",this,e),r.cloneDeep(t[e].newValue),!0))}},t.prototype.rollbackAttributes=function(){var t=this[b];for(var e in t)t.hasOwnProperty(e)&&t[e].hasDirtyAttributes&&(this[e]=r.cloneDeep(t[e].oldValue))},Object.defineProperty(t.prototype,"modelConfig",{get:function(){return Reflect.getMetadata("JsonApiModelConfig",this.constructor)},enumerable:!0,configurable:!0}),t.prototype.parseHasMany=function(t,e,r){var i,a,o,s,l=Reflect.getMetadata("HasMany",this);if(l)try{for(var u=p(l),d=u.next();!d.done;d=u.next()){var f=d.value,c=t.relationships?t.relationships[f.relationship]:null;if(c&&c.data&&Array.isArray(c.data)){var h=[],y=[];try{for(var g=(o=void 0,p(Object.keys(c.data))),v=g.next();!v.done;v=g.next()){var b=v.value,m=c.data[b].type;if(!n(y,m)){y.push(m);var M=Reflect.getMetadata("JsonApiDatastoreConfig",this.internalDatastore.constructor).models[m];if(M){var R=this.getHasManyRelationship(M,c.data,e,m,r);R.length>0&&(h=h.concat(R))}else console.error("parseHasMany - Model type for relationship "+m+" not found.")}}}catch(t){o={error:t}}finally{try{v&&!v.done&&(s=g.return)&&s.call(g)}finally{if(o)throw o.error}}this[f.propertyName]=h}}}catch(t){i={error:t}}finally{try{d&&!d.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}},t.prototype.parseBelongsTo=function(t,e,r){var i,n,a=Reflect.getMetadata("BelongsTo",this);if(a)try{for(var o=p(a),s=o.next();!s.done;s=o.next()){var l=s.value,u=t.relationships?t.relationships[l.relationship]:null;if(u&&u.data){var d=u.data instanceof Array?u.data[0]:u.data;if(d){var f=d.type,c=Reflect.getMetadata("JsonApiDatastoreConfig",this.internalDatastore.constructor).models[f];if(c){var h=this.getBelongsToRelationship(c,d,e,f,r);h?this[l.propertyName]=h:this.unresolvedRelations[l.propertyName]=d}else console.error("parseBelongsTo - Model type for relationship "+f+" not found.")}}}}catch(t){i={error:t}}finally{try{s&&!s.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}},t.prototype.getHasManyRelationship=function(t,e,r,n,a){var o=this,s=[];return e.forEach(function(e){var l=i(r,{id:e.id,type:n});if(l){var u=o.createOrPeek(t,l),d=a.indexOf(l),p=a.concat([]);-1!==d&&(p.splice(d,1),u.syncRelationships(l,r,p)),s.push(u)}else{var f=Reflect.getMetadata("JsonApiDatastoreConfig",o.internalDatastore.constructor).models[n];(u=o.internalDatastore.peekRecord(f,e.id))&&s.push(u)}}),s},t.prototype.getBelongsToRelationship=function(t,e,r,n,a){var o=e.id,s=i(r,{id:o,type:n});if(s){var l=this.createOrPeek(t,s),u=a.indexOf(s),d=a.concat([]);return-1!==u&&(d.splice(u,1),l.syncRelationships(s,r,d)),l}return this.internalDatastore.peekRecord(t,o)},t.prototype.createOrPeek=function(t,e){var i=this.internalDatastore.peekRecord(t,e.id);if(i)return r.extend(i,this.internalDatastore.transformSerializedNamesToPropertyNames(t,e.attributes)),i;var n=this.internalDatastore.deserializeModel(t,e);return this.internalDatastore.addToStore(n),n},t}();var R=function(t){this.errors=[],t&&(this.errors=t)};var A=function(){function t(t,e){this.jsonApiModels=t,this.metaData=e}return t.prototype.getModels=function(){return this.jsonApiModels},t.prototype.getMeta=function(){return this.metaData},t}();var D=y,O=function(){function t(t){this.http=t,this.globalRequestOptions={},this.internalStore={},this.toQueryString=this.datastoreConfig.overrides&&this.datastoreConfig.overrides.toQueryString?this.datastoreConfig.overrides.toQueryString:this._toQueryString}return Object.defineProperty(t.prototype,"headers",{set:function(t){this.globalHeaders=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"requestOptions",{set:function(t){this.globalRequestOptions=t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"datastoreConfig",{get:function(){var t=Reflect.getMetadata("JsonApiDatastoreConfig",this.constructor);return Object.assign(t,this.config)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"getDirtyAttributes",{get:function(){return this.datastoreConfig.overrides&&this.datastoreConfig.overrides.getDirtyAttributes?this.datastoreConfig.overrides.getDirtyAttributes:t.getDirtyAttributes},enumerable:!0,configurable:!0}),t.getDirtyAttributes=function(t){var e={};for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];if(i.hasDirtyAttributes)e[null!=i.serializedName?i.serializedName:r]=i.serialisationValue?i.serialisationValue:i.newValue}return e},t.prototype.query=function(t,e,r,i){var n=this,a=this.buildHttpHeaders(r),o=this.buildUrl(t,e,void 0,i);return this.http.get(o,{headers:a}).pipe(s.map(function(e){return n.extractQueryData(e,t)}),s.catchError(function(t){return n.handleError(t)}))},t.prototype.findAll=function(t,e,r,i){var n=this,a=this.buildUrl(t,e,void 0,i),o=this.buildRequestOptions({headers:r,observe:"response"});return this.http.get(a,o).pipe(s.map(function(e){return n.extractQueryData(e,t,!0)}),s.catchError(function(t){return n.handleError(t)}))},t.prototype.findRecord=function(t,e,r,i,n){var a=this,o=this.buildRequestOptions({headers:i,observe:"response"}),l=this.buildUrl(t,r,e,n);return this.http.get(l,o).pipe(s.map(function(e){return a.extractRecordData(e,t)}),s.catchError(function(t){return a.handleError(t)}))},t.prototype.createRecord=function(t,e){return new t(this,{attributes:e})},t.prototype.saveRecord=function(t,e,r,i,n){var a=this,o=e.constructor,u=e.modelConfig.type,d=this.getRelationships(e),p=this.buildUrl(o,r,e.id,n),f={data:{relationships:d,type:u,id:e.id,attributes:this.getDirtyAttributes(t,e)}},c=this.buildRequestOptions({headers:i,observe:"response"});return(e.id?this.http.patch(p,f,c):this.http.post(p,f,c)).pipe(s.map(function(t){return-1!==[200,201].indexOf(t.status)?a.extractRecordData(t,o,e):e}),s.catchError(function(t){return null==t?l.of(e):a.handleError(t)}),s.map(function(t){return a.updateRelationships(t,d)}))},t.prototype.deleteRecord=function(t,e,r,i){var n=this,a=this.buildRequestOptions({headers:r}),o=this.buildUrl(t,null,e,i);return this.http.delete(o,a).pipe(s.catchError(function(t){return n.handleError(t)}))},t.prototype.peekRecord=function(t,e){var r=Reflect.getMetadata("JsonApiModelConfig",t).type;return this.internalStore[r]?this.internalStore[r][e]:null},t.prototype.peekAll=function(t){var e=Reflect.getMetadata("JsonApiModelConfig",t).type,r=this.internalStore[e];return r?Object.keys(r).map(function(t){return r[t]}):[]},t.prototype.deserializeModel=function(t,e){return e.attributes=this.transformSerializedNamesToPropertyNames(t,e.attributes),new t(this,e)},t.prototype.addToStore=function(t){var e,r,i=Array.isArray(t)?t:[t],n=i[0].modelConfig.type,a=this.internalStore[n];a||(a=this.internalStore[n]={});try{for(var o=p(i),s=o.next();!s.done;s=o.next()){var l=s.value;a[l.id]=l}}catch(t){e={error:t}}finally{try{s&&!s.done&&(r=o.return)&&r.call(o)}finally{if(e)throw e.error}}},t.prototype.transformSerializedNamesToPropertyNames=function(t,e){var r=this.getModelPropertyNames(t.prototype),i={};return Object.keys(r).forEach(function(t){e&&(i[r[t]]=e[t])}),i},t.prototype.buildUrl=function(t,e,r,i){var n=this.toQueryString(e);if(i)return n?i+"?"+n:i;var a=Reflect.getMetadata("JsonApiModelConfig",t),o=[a.baseUrl||this.datastoreConfig.baseUrl,a.apiVersion||this.datastoreConfig.apiVersion,a.modelEndpointUrl||a.type,r].filter(function(t){return t}).join("/");return n?o+"?"+n:o},t.prototype.getRelationships=function(t){var e,r=this,i=Reflect.getMetadata("BelongsTo",t)||[],n=Reflect.getMetadata("HasMany",t)||[],a=function(a){if(t.hasOwnProperty(a))if(t[a]instanceof M){if(e=e||{},t[a].id){var s=(l=i.find(function(t){return t.propertyName===a})).relationship;e[s]={data:o.buildSingleRelationshipData(t[a])}}}else if(t[a]instanceof Array){var l;if((l=n.find(function(t){return t.propertyName===a}))&&o.isValidToManyRelation(t[a])){e=e||{};s=l.relationship;var u=t[a].filter(function(t){return t.id}).map(function(t){return r.buildSingleRelationshipData(t)});e[s]={data:u}}}},o=this;for(var s in t)a(s);return e},t.prototype.isValidToManyRelation=function(t){return!t.length||!!t.every(function(t){return t instanceof M})&&1===t.map(function(t){return t.modelConfig.modelEndpointUrl||t.modelConfig.type}).filter(function(t,e,r){return r.indexOf(t)===e}).length},t.prototype.buildSingleRelationshipData=function(t){var e={type:t.modelConfig.type};if(t.id)e.id=t.id;else{var r=Reflect.getMetadata("Attribute",t);e.attributes=this.getDirtyAttributes(r,t)}return e},t.prototype.extractQueryData=function(t,e,r){var i=this;void 0===r&&(r=!1);var n=t.body,a=[];return n.data.forEach(function(t){var r=i.datastoreConfig.models[t.type];r=r||e;var o=i.deserializeModel(r,t);i.addToStore(o),n.included&&(o.syncRelationships(t,n.included.concat(t)),i.addToStore(o)),a.push(o)}),r&&!0===r?new A(a,this.parseMeta(n,e)):a},t.prototype.extractRecordData=function(t,e,r){var i=t.body;if(!i||"null"===i)throw new Error("no body in response");if(!i.data){if(201===t.status||!r)throw new Error("expected data in response");return r}r&&(r.modelInitialization=!0,r.id=i.data.id,Object.assign(r,i.data.attributes),r.modelInitialization=!1);var n=r||this.deserializeModel(e,i.data);return this.addToStore(n),i.included&&(n.syncRelationships(i.data,i.included),this.addToStore(n)),n},t.prototype.handleError=function(t){if(t instanceof o.HttpErrorResponse&&t.error instanceof Object&&t.error.errors&&t.error.errors instanceof Array){var e=new R(t.error.errors);return l.throwError(e)}return l.throwError(t)},t.prototype.parseMeta=function(t,e){return new(0,Reflect.getMetadata("JsonApiModelConfig",e).meta)(t)},t.prototype.getOptions=function(t){return{headers:this.buildHttpHeaders(t)}},t.prototype.buildHttpHeaders=function(t){var e=this,r=new o.HttpHeaders({Accept:"application/vnd.api+json","Content-Type":"application/vnd.api+json"});return this.globalHeaders&&this.globalHeaders.keys().forEach(function(t){e.globalHeaders.has(t)&&(r=r.set(t,e.globalHeaders.get(t)))}),t&&t.keys().forEach(function(e){t.has(e)&&(r=r.set(e,t.get(e)))}),r},t.prototype.resetMetadataAttributes=function(t,e,r){for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];n.hasDirtyAttributes&&(n.hasDirtyAttributes=!1)}return t[D]=e,t},t.prototype.updateRelationships=function(t,e){var r=Reflect.getMetadata("JsonApiDatastoreConfig",this.constructor).models;for(var n in e)if(e.hasOwnProperty(n)&&t.hasOwnProperty(n)){var a=t[n],o=Reflect.getMetadata("HasMany",a),s=i(o,function(e){return r[e.relationship]===t.constructor});if(s){a[s.propertyName]=a[s.propertyName]||[];var l=a[s.propertyName].indexOf(t);-1===l?a[s.propertyName].push(t):a[s.propertyName][l]=t}}return t},t.prototype.getModelPropertyNames=function(t){return Reflect.getMetadata("AttributeMapping",t)||[]},t.prototype.buildRequestOptions=function(t){void 0===t&&(t={});var e=this.buildHttpHeaders(t.headers),r=Object.assign(t,{headers:e});return Object.assign(this.globalRequestOptions,r)},t.prototype._toQueryString=function(t){return u.stringify(t,{arrayFormat:"brackets"})},t.decorators=[{type:a.Injectable}],t.ctorParameters=function(){return[{type:o.HttpClient}]},t}();var k=[O],w=function(){function t(){}return t.decorators=[{type:a.NgModule,args:[{providers:[k],exports:[o.HttpClientModule]}]}],t}();t.Attribute=function(t){return void 0===t&&(t={}),function(e,i){var n=function(e,r,i){var n;if(void 0===i&&(i=!1),t.converter)n=t.converter;else if(e===Date)n=new g;else{var a=new e;a.mask&&a.unmask&&(n=a)}return n?i?n.unmask(r):n.mask(r):r};delete e[i]&&(!function(){var r=Reflect.getMetadata("Attribute",e)||{};r[i]={marked:!0},Reflect.defineMetadata("Attribute",r,e);var n=Reflect.getMetadata("AttributeMapping",e)||{};n[void 0!==t.serializedName?t.serializedName:i]=i,Reflect.defineMetadata("AttributeMapping",n,e)}(),Object.defineProperty(e,i,{get:function(){return this["_"+i]},set:function(a){var o=Reflect.getMetadata("design:type",e,i),s=n(o,a),l=null;this.isModelInitialization()&&this.id?l=n(o,a):this[y]&&this[y][i]&&(l=this[y][i].oldValue),this["_"+i]=s,function(a,o,s){var l=Reflect.getMetadata("design:type",e,i);a[y]||(a[y]={}),a[y][i]={newValue:s,oldValue:o,nested:!1,serializedName:t.serializedName,hasDirtyAttributes:!r.isEqual(o,s),serialisationValue:n(l,s,!0)}}(this,l,s)},enumerable:!0,configurable:!0}))}},t.BelongsTo=function(t){return void 0===t&&(t={}),function(e,r){var i=Reflect.getMetadata("BelongsTo",e)||[];i.push({propertyName:r,relationship:t.key||r}),Reflect.defineMetadata("BelongsTo",i,e)}},t.DEFAULT_OPTIONS=c,t.ErrorResponse=R,t.HasMany=function(t){return void 0===t&&(t={}),function(e,r){var i=Reflect.getMetadata("HasMany",e)||[];i.push({propertyName:r,relationship:t.key||r}),Reflect.defineMetadata("HasMany",i,e)}},t.JsonApiDatastore=O,t.JsonApiDatastoreConfig=function(t){return void 0===t&&(t={}),function(e){Reflect.defineMetadata("JsonApiDatastoreConfig",t,e)}},t.JsonApiMetaModel=v,t.JsonApiModel=M,t.JsonApiModelConfig=function(t){return function(e){void 0!==t.meta&&null!=t.meta||(t.meta=v),Reflect.defineMetadata("JsonApiModelConfig",t,e)}},t.JsonApiModule=w,t.JsonApiNestedModel=f,t.JsonApiQueryData=A,t.JsonAttribute=function(t){return void 0===t&&(t={}),function(e,r){var i=function(e,r,i){var n;if(void 0===i&&(i=!1),t.converter)n=t.converter;else if(e===Date)n=new g;else{var a=new e;a.mask&&a.unmask&&(n=a)}return n?i?n.unmask(r):n.mask(r):r};delete e[r]&&(!function(){var i=Reflect.getMetadata("JsonAttribute",e)||{};i[r]={marked:!0},Reflect.defineMetadata("JsonAttribute",i,e);var n=Reflect.getMetadata("AttributeMapping",e)||{};n[void 0!==t.serializedName?t.serializedName:r]=r,Reflect.defineMetadata("AttributeMapping",n,e)}(),Object.defineProperty(e,r,{get:function(){return this.nestedDataSerialization?i(Reflect.getMetadata("design:type",e,r),this["_"+r],!0):this["_"+r]},set:function(t){var n=Reflect.getMetadata("design:type",e,r);this["_"+r]=i(n,t)},enumerable:!0,configurable:!0}))}},t.JsonModelConverter=h,t.NestedAttribute=function(t){return void 0===t&&(t={}),function(e,i){var n=function(e,r,i){var n;if(void 0===i&&(i=!1),t.converter)n=t.converter;else{var a=new e;a.mask&&a.unmask&&(n=a)}return n?i?n.unmask(r):n.mask(r):r};delete e[i]&&(!function(){var r=Reflect.getMetadata("NestedAttribute",e)||{};r[i]={marked:!0},Reflect.defineMetadata("NestedAttribute",r,e);var n=Reflect.getMetadata("AttributeMapping",e)||{};n[void 0!==t.serializedName?t.serializedName:i]=i,Reflect.defineMetadata("AttributeMapping",n,e)}(),Object.defineProperty(e,i,{get:function(){return this["_"+i]},set:function(t){var a=Reflect.getMetadata("design:type",e,i);this["_"+i]=n(a,t),function(t){var e=t["_"+i];if(t[y]||(t[y]={}),t[y][i]&&!t.isModelInitialization())t[y][i].newValue=e,t[y][i].hasDirtyAttributes=!r.isEqual(t[y][i].oldValue,e),t[y][i].serialisationValue=e;else{var a=r.cloneDeep(e);t[y][i]={newValue:e,oldValue:a,converter:n,nested:!0,hasDirtyAttributes:!r.isEqual(e,a)}}}(this)},enumerable:!0,configurable:!0}))}},t.PROVIDERS=k,Object.defineProperty(t,"__esModule",{value:!0})});
//# sourceMappingURL=angular2-jsonapi.umd.min.js.map